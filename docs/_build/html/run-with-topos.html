
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Run with ToPoS &#8212; RESEDA  documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="How to cite" href="how-to-cite.html" />
    <link rel="prev" title="Run standalone" href="run-standalone.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="run-with-topos">
<h1>Run with ToPoS<a class="headerlink" href="#run-with-topos" title="Permalink to this headline">¶</a></h1>
<p>How to run - Using ToPoS for sending jobs and using a job monitor tool</p>
<p>Note: this is what Barbera does for each sequence run</p>
<p>ToPoS: <a class="reference external" href="https://topos.grid.sara.nl/4.1/">https://topos.grid.sara.nl/4.1/</a></p>
<p>Job monitoring tool: <a class="reference external" href="https://bitbucket.org/barbera/progress/">https://bitbucket.org/barbera/progress/</a></p>
<div class="section" id="helper-scripts">
<h2>Helper scripts<a class="headerlink" href="#helper-scripts" title="Permalink to this headline">¶</a></h2>
<p>Fill in the run name and output directory in ENV.sh and source the script. You
can use the environment variables when you go through the steps below.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">RUN</span><span class="o">=</span>run30-20180723-miseq
<span class="nv">OUTDIR</span><span class="o">=</span>results-tbcell
<span class="nv">WEBDAV</span><span class="o">=</span>https://researchdrive.surfsara.nl/remote.php/webdav/amc-immunogenomics/RUNS/<span class="si">${</span><span class="nv">RUN</span><span class="si">}</span>
<span class="nv">POOLNAME</span><span class="o">=</span>d8c24f78f9772cbdff54cf62
</pre></div>
</div>
<p>Files can be copied from the webdav server by adding file paths in SAMPLES and
then use:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./copy-from-beehub.sh
</pre></div>
</div>
<p>Example of the content in the SAMPLES file:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>/mnt/immunogenomics/RUNS/TESTDATA/data/test-B_S1_L001_R1_001.fastq.gz
/mnt/immunogenomics/RUNS/TESTDATA/data/test-B_S1_L001_R2_001.fastq.gz
/mnt/immunogenomics/RUNS/TESTDATA/data/test-T_S2_L001_R1_001.fastq.gz
/mnt/immunogenomics/RUNS/TESTDATA/data/test-T_S2_L001_R2_001.fastq.gz
</pre></div>
</div>
<p>Data can be transferred from the webdav server with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./copy-to-webdav.sh WEBDAVURL FILE1 <span class="o">[</span>FILE2<span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="preparation">
<h2>Preparation<a class="headerlink" href="#preparation" title="Permalink to this headline">¶</a></h2>
<p>Mount basespace. Instructions are in basespace.txt</p>
<p>Specify the run and the basespace sub-directories as argument to
copy-basespace-data-to-beehub.py and run it. The file basespace-copy-data.sh
and basespace-calc-checksum.sh will be created. Run these scripts to copy the
data from basespace to the ResearchDrive and to calculate the SHA1 sums
(last one is needed for the VerifyBasespaceCopy.py script)</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>python copy-basespace-data-to-beehub.py -r runNN-yyyymmdd-miseq run-dir-in-project-dir-on-basespace
nohup bash basespace-copy-data.sh &gt; nohup-copy.out <span class="m">2</span>&gt; nohup-copy.err &lt; /dev/null <span class="p">&amp;</span>
nohup bash basespace-calc-checksum.sh &gt; nohup-check.out <span class="m">2</span>&gt; nohup-check.err &lt; /dev/null <span class="p">&amp;</span>
</pre></div>
</div>
<p>Convert the MiSeq sample sheet with MetaData.py (creates a json file)</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>python MetaData.py Miseq-sample-Datasheet.csv
</pre></div>
</div>
<p>Mount the ResearchDrive webdav server</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo mount -t davfs -o <span class="nv">uid</span><span class="o">=</span>bioinfo,gid<span class="o">=</span>bioinfo,rw https://researchdrive.surfsara.nl/remote.php/webdav/amc-immunogenomics /mnt/immunogenomics
</pre></div>
</div>
<p>Verify if all data has been copied</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>python2 VerifyBasespaceCopy.py <span class="p">|</span>grep grep
</pre></div>
</div>
<p>You need the mounted ResearchDrive directory name and the json file from the previous step.</p>
<p>Add extra information to the json file with MakeSamplesFiles.py (this will also make the SAMPLE-* files)</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>python MakeSamplesFiles.py -r yyyymmdd-RUNnn-datasheet.json -w /mnt/immunogenomics/RUNS/runNN-yyyymmdd-miseq/data/
</pre></div>
</div>
<p>Sort and split the SAMPLE-* files with: SortAndSplit.sh It does the following:</p>
<blockquote>
<div><ul class="simple">
<li>Sorts the SAMPLE-* files: sort SAMPLE-blah &gt; SAMPLE-blah.sort</li>
<li>Makes manageable jobs by splitting the SAMPLE-*.sort files, e.g.: split -l 20 SAMPLES-run13-human-BCRh.sort SAMPLES-run13-human-BCRh-</li>
</ul>
</div></blockquote>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./SortAndSplit.sh SAMPLE-*
</pre></div>
</div>
<p>Create Topos jobs with ToposCreateTokens.py (run with the -h option to see the arguments)</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>python ToposCreateTokens.py -r runNN-yyyymmdd-miseq -m MIDS-miseq-umi.txt -o results-tbcell -p paired -b yes -u yes
</pre></div>
</div>
<p>Upload Topos jobs with ToposUploadFiles.py (run without arguments to see the arguments)</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>python ToposUploadFiles.py d8c24f78f9772cbdff54cf62 tokens/*
</pre></div>
</div>
</div>
<div class="section" id="starting-the-jobs">
<h2>Starting the jobs<a class="headerlink" href="#starting-the-jobs" title="Permalink to this headline">¶</a></h2>
<p>Start virtual machines for the analysis (in the SurfSara HPC cloud webinterface)
<a class="reference external" href="https://ui.hpccloud.surfsara.nl/">https://ui.hpccloud.surfsara.nl/</a></p>
<p>Add all ip-adresses to the ip-list file in the ‘../progress’ directory (the job monitoring tool)</p>
<p>Transfer the setup-and-run.sh by running roll-out-scripts.py and executing the
code that was generated by this roll-out script</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>python roll-out-scripts.py &gt; tmp.sh
bash tmp.sh
</pre></div>
</div>
<p>Login to each machine and run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./setup-and-run.sh
</pre></div>
</div>
</div>
<div class="section" id="when-all-jobs-are-finished">
<h2>When all jobs are finished<a class="headerlink" href="#when-all-jobs-are-finished" title="Permalink to this headline">¶</a></h2>
<p>In the jobs the data is automatically transferred to the ResearchDrive webdav server</p>
<p>Execute ConcatenateCloneFilesBatch.py to generate a bash script for
concatenating clone files per project+organism+cell_type (run the generated script)</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>python ConcatenateCloneFilesBatch.py -r yyyymmdd-RUNnn-datasheet-new.json -w /mnt/immunogenomics/RUNS/runNN-yyyymmdd-miseq/results-tbcell/final/ &gt; tmp.sh
nohup bash tmp.sh &gt; nohup-concat.out <span class="m">2</span>&gt; nohup-concat.err &lt; /dev/null <span class="p">&amp;</span>
</pre></div>
</div>
<p>Run report-ALL.sh to generate reports about the sequence run (help is available for this script if you do not give arguments)</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./report-ALL.sh -r runNN-YYYYMMDD-miseq -i yyyymmdd_RUNnn_Datasheet-new.json -b yes -o results-tbcell
</pre></div>
</div>
<p>Check for contamination with contamination-figure.R or the pandas-sample-similarity.ipynb notebook</p>
<ul class="simple">
<li>Specify the files that were created by ConcatenateCloneFilesBatch.py</li>
<li>Specify the pt.table.csv that you got from the immunogenomics group</li>
<li>Check by hand if the column names in the pt.table are correct</li>
<li>Run the script</li>
<li>Usually the reports are made for all samples per cell_type</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="contents.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Run with ToPoS</a><ul>
<li><a class="reference internal" href="#helper-scripts">Helper scripts</a></li>
<li><a class="reference internal" href="#preparation">Preparation</a></li>
<li><a class="reference internal" href="#starting-the-jobs">Starting the jobs</a></li>
<li><a class="reference internal" href="#when-all-jobs-are-finished">When all jobs are finished</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="contents.html">Documentation overview</a><ul>
  <li><a href="index.html">Welcome to RESEDA’s documentation!</a><ul>
      <li>Previous: <a href="run-standalone.html" title="previous chapter">Run standalone</a></li>
      <li>Next: <a href="how-to-cite.html" title="next chapter">How to cite</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/run-with-topos.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Barbera DC van Schaik.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="_sources/run-with-topos.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>