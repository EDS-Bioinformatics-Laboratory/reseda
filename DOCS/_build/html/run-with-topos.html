
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Run with ToPoS &#8212; RESEDA  documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="How to cite" href="how-to-cite.html" />
    <link rel="prev" title="Run standalone" href="run-standalone.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="run-with-topos">
<h1>Run with ToPoS<a class="headerlink" href="#run-with-topos" title="Permalink to this headline">¶</a></h1>
<p>How to run - Using ToPoS for sending jobs and using a job monitor tool</p>
<p>Note: this is what Barbera does for each sequence run</p>
<p>ToPoS: <a class="reference external" href="https://topos.grid.sara.nl/4.1/">https://topos.grid.sara.nl/4.1/</a></p>
<p>Job monitoring tool: <a class="reference external" href="https://bitbucket.org/barbera/progress/">https://bitbucket.org/barbera/progress/</a></p>
<div class="section" id="helper-scripts">
<h2>Helper scripts<a class="headerlink" href="#helper-scripts" title="Permalink to this headline">¶</a></h2>
<p>Fill in the run name and output directory in ENV.sh and source the script. You
can use the environment variables when you go through the steps below.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">RUN</span><span class="o">=</span>run30-20180723-miseq
<span class="nv">OUTDIR</span><span class="o">=</span>results-tbcell
<span class="nv">WEBDAV</span><span class="o">=</span>https://researchdrive.surfsara.nl/remote.php/webdav/amc-immunogenomics/RUNS/<span class="si">${</span><span class="nv">RUN</span><span class="si">}</span>
<span class="nv">POOLNAME</span><span class="o">=</span>d8c24f78f9772cbdff54cf62
</pre></div>
</div>
<p>Files can be copied from the webdav server by adding file paths in SAMPLES and
then use:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./copy-from-beehub.sh
</pre></div>
</div>
<p>Example of the content in the SAMPLES file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/mnt/immunogenomics/RUNS/TESTDATA/data/test-B_S1_L001_R1_001.fastq.gz
/mnt/immunogenomics/RUNS/TESTDATA/data/test-B_S1_L001_R2_001.fastq.gz
/mnt/immunogenomics/RUNS/TESTDATA/data/test-T_S2_L001_R1_001.fastq.gz
/mnt/immunogenomics/RUNS/TESTDATA/data/test-T_S2_L001_R2_001.fastq.gz
</pre></div>
</div>
<p>Data can be transferred from the webdav server with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./copy-to-webdav.sh WEBDAVURL FILE1 <span class="o">[</span>FILE2<span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="preparation">
<h2>Preparation<a class="headerlink" href="#preparation" title="Permalink to this headline">¶</a></h2>
<p>Mount the ResearchDrive from the home directory on the cloud machine and create a directory from the new run.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./mount-beehub.sh
mkdir /mnt/immunogenomics/RUNS/run35-20190609-miseq
mkdir /mnt/immunogenomics/RUNS/run35-20190609-miseq/data
</pre></div>
</div>
<p>Mount basespace from the home directory. Instructions are in basespace.txt (you need the password for Illumina base space, Rebecca has it) The latest sequence run is in basespace/Projects/</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>basemount basespace
</pre></div>
</div>
<p>Specify the run and the basespace sub-directories as argument to
copy-basespace-data-to-beehub.py and run it. The file basespace-copy-data.sh
and basespace-calc-checksum.sh will be created. Run these scripts to copy the
data from basespace to the ResearchDrive and to calculate the SHA1 sums
(last one is needed for the VerifyBasespaceCopy.py script)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python copy-basespace-data-to-beehub.py -r runNN-yyyymmdd-miseq run-dir-in-project-dir-on-basespace
nohup bash basespace-copy-data.sh &gt; nohup-copy.out <span class="m">2</span>&gt; nohup-copy.err &lt; /dev/null <span class="p">&amp;</span>
nohup bash basespace-calc-checksum.sh &gt; nohup-check.out <span class="m">2</span>&gt; nohup-check.err &lt; /dev/null <span class="p">&amp;</span>
</pre></div>
</div>
<p>The immunogenomics group normally sends a semicolon-separated files with all the required information. When you receive a so-called ‘pt-table’ file you need to copy/paste this information in a ‘datasheet’. Download one of the earlier datasheets (e.g. from the previous run), edit the header to match it with the latest sequence run and copy/paste the right columns in this sheet. The order of the columns is not important, but the column names are.</p>
<p>Convert the MiSeq sample sheet (datasheet) with MetaData.py (creates a json file)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python MetaData.py Miseq-sample-Datasheet.csv &gt; Miseq-sample-Datasheet.json
</pre></div>
</div>
<p>Mount the ResearchDrive webdav server if you have not done so already.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo mount -t davfs -o <span class="nv">uid</span><span class="o">=</span>bioinfo,gid<span class="o">=</span>bioinfo,rw https://researchdrive.surfsara.nl/remote.php/webdav/amc-immunogenomics /mnt/immunogenomics
</pre></div>
</div>
<p>Verify if all data has been copied (optional). Note that the SHAsum verification does not work currently.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python2 VerifyBasespaceCopy.py -i yyyymmdd_RUNxx_Datasheet.json -r runNN-yyyymmdd-miseq
</pre></div>
</div>
<p>You need the mounted ResearchDrive directory name and the json file from the previous step.</p>
<p>Add extra information to the json file with MakeSamplesFiles.py (this will also make the SAMPLE-* files)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python MakeSamplesFiles.py -r yyyymmdd-RUNnn-datasheet.json -w /mnt/immunogenomics/RUNS/runNN-yyyymmdd-miseq/data/
</pre></div>
</div>
<p>Sort and split the SAMPLE-* files with: SortAndSplit.sh It does the following:</p>
<blockquote>
<div><ul class="simple">
<li><p>Sorts the SAMPLE-* files: sort SAMPLE-blah &gt; SAMPLE-blah.sort</p></li>
<li><p>Makes manageable jobs by splitting the SAMPLE-*.sort files, e.g.: split -l 20 SAMPLES-run13-human-BCRh.sort SAMPLES-run13-human-BCRh-</p></li>
</ul>
</div></blockquote>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./SortAndSplit.sh SAMPLE-*
</pre></div>
</div>
<p>Create Topos jobs with ToposCreateTokens.py (run with the -h option to see the arguments)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python ToposCreateTokens.py -r runNN-yyyymmdd-miseq -m MIDS-miseq-umi.txt -o results-tbcell -p paired -b yes -u yes
</pre></div>
</div>
<p>Upload Topos jobs with ToposUploadFiles.py (run without arguments to see the arguments)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python ToposUploadFiles.py d8c24f78f9772cbdff54cf62 tokens/*
</pre></div>
</div>
</div>
<div class="section" id="starting-the-jobs">
<h2>Starting the jobs<a class="headerlink" href="#starting-the-jobs" title="Permalink to this headline">¶</a></h2>
<p>Start virtual machines for the analysis (in the SurfSara HPC cloud webinterface)
<a class="reference external" href="https://ui.hpccloud.surfsara.nl/">https://ui.hpccloud.surfsara.nl/</a></p>
<p>Add all ip-adresses to the ip-list file in the ‘../progress’ directory (the job monitoring tool)</p>
<p>Transfer the setup-and-run.sh by running roll-out-scripts.py and executing the
code that was generated by this roll-out script</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python roll-out-scripts.py &gt; tmp.sh
bash tmp.sh
</pre></div>
</div>
<p>Login to each machine and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./setup-and-run.sh
</pre></div>
</div>
<p>When you see “Serving HTTP on 0.0.0.0 port 8000 …” do ctrl+a d. This will detach the current “screen” and run the process in the background. After this the script will continue. Log out when you get the prompt back. The ToPoS job has started in the background. Repeat for all the other virtual machines.</p>
</div>
<div class="section" id="check-progress-of-the-analysis">
<h2>Check progress of the analysis<a class="headerlink" href="#check-progress-of-the-analysis" title="Permalink to this headline">¶</a></h2>
<p>Go to the “progress” repository and run the display.py script. When all jobs are “FINISHED” you can move on and generate clone files and reports.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> ../progress
./display.py
</pre></div>
</div>
<p>The status of the jobs can also be traced via ToPoS. <a class="reference external" href="https://topos.grid.sara.nl/4.1/pools/d8c24f78f9772cbdff54cf62/">https://topos.grid.sara.nl/4.1/pools/d8c24f78f9772cbdff54cf62/</a> The analysis is finished when there are no more jobs (tokens) left.</p>
</div>
<div class="section" id="when-all-jobs-are-finished">
<h2>When all jobs are finished<a class="headerlink" href="#when-all-jobs-are-finished" title="Permalink to this headline">¶</a></h2>
<p>In the jobs the data is automatically transferred to the ResearchDrive webdav server</p>
<p>Execute ConcatenateCloneFilesBatch.py to generate a bash script for
concatenating clone files per project+organism+cell_type (run the generated script)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python ConcatenateCloneFilesBatch.py -r yyyymmdd-RUNnn-datasheet-new.json -w /mnt/immunogenomics/RUNS/runNN-yyyymmdd-miseq/results-tbcell/final/ &gt; tmp.sh
nohup bash tmp.sh &gt; nohup-concat.out <span class="m">2</span>&gt; nohup-concat.err &lt; /dev/null <span class="p">&amp;</span>
</pre></div>
</div>
<p>Run report-ALL.sh to generate reports about the sequence run (help is available for this script if you do not give arguments)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./report-ALL.sh -r runNN-YYYYMMDD-miseq -i yyyymmdd_RUNnn_Datasheet-new.json -b yes -o results-tbcell
</pre></div>
</div>
<p>Check for contamination with contamination-figure.R or the pandas-sample-similarity.ipynb notebook</p>
<ul class="simple">
<li><p>Specify the files that were created by ConcatenateCloneFilesBatch.py</p></li>
<li><p>Specify the pt.table.csv that you got from the immunogenomics group</p></li>
<li><p>Check by hand if the column names in the pt.table are correct</p></li>
<li><p>Run the script</p></li>
<li><p>Usually the reports are made for all samples per cell_type</p></li>
</ul>
<p>Starting the jupyter notebook server:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jupyter notebook --no-browser
</pre></div>
</div>
<p>The (password-protected) notebook will be accessible via the ip address of the virtual machine and port 8888. E.g. <a class="reference external" href="http://145.100.57.10:8888/">http://145.100.57.10:8888/</a></p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Welcome to RESEDA’s documentation!</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#running-the-software-on-one-machine">Running the software on one machine</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#running-the-software-on-multiple-machines">Running the software on multiple machines</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#table-of-contents">Table of contents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="settings.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="input-files.html">Prepare input files</a></li>
<li class="toctree-l1"><a class="reference internal" href="run-standalone.html">Run standalone</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Run with ToPoS</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#helper-scripts">Helper scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preparation">Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#starting-the-jobs">Starting the jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#check-progress-of-the-analysis">Check progress of the analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#when-all-jobs-are-finished">When all jobs are finished</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="input-files.html">Prepare input files</a></li>
<li class="toctree-l1"><a class="reference internal" href="how-to-cite.html">How to cite</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="contact.html">Contact</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Barbera DC van Schaik.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.1.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/run-with-topos.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>